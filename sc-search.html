<link rel="import" href="../core-ajax/core-ajax.html">
<link rel="import" href="../font-roboto/roboto.html">
<link rel="import" href="../core-toolbar/core-toolbar.html">
<link rel="import" href="../paper-elements/paper-elements.html">
<link rel="import" href="../core-icon/core-icon.html">
<link rel="import" href="../core-iconset/core-iconset.html">
<!--
sc-search is an custom element to generic searches based in a preset model. That
is required core-ajax.

##### Example

    <sc-search url="http://api.randomuser.me/"></sc-search>

@element sc-search
@blurb Element providing the search to the sisComando app.
@status alpha
@homepage http://github.com/siscomando/sc-search
-->
<polymer-element class="core-header" name="sc-search" attributes="notitle author url">

  <template>
    <link rel="stylesheet" href="sc-search.css">

    <core-ajax id="coreAjax" 
     url="{{url}}" handleAs="json"
     response="{{response}}"
     params='{"s":"", "register":""}'
     method="POST"
     contenttype="application/json"
     ></core-ajax>

    <core-iconset id="sc-icons-png" src="../sc-icons/sc-icons.png" width="96" iconSize="24" 
    icons="hashtag hashtag-red notifications notifications-red">
    </core-iconset>  
      
    <!-- init element sc-search -->
    <div class="container-header" vertical layout>
      <core-toolbar class="sc-search-input {{ displaySearch ? 'on-search' : '' }}">
        <paper-icon-button id="menu" icon="menu" on-tap="{{toogleMenu}}"></paper-icon-button>
        <div></div>
        <core-icon icon="search" on-tap="{{onDisplaySearch}}">
        </core-icon>
        <paper-input-decorator id="parentsearch" label="Pesquise qualquer coisa..." flex>
          <input id="search" is="core-input" name="s" on-blur="{{onDisplaySearch}}"
          on-keyup="{{getSearch}}" on-focus="{{setIn}}" value="">
        </paper-input-decorator>
        <paper-icon-button icon="speaker-notes" on-tap="{{showNotifications}}"></paper-icon-button>
        <paper-icon-button icon="sc-icons-png:hashtag" on-tap="{{showHashtags}}"></paper-icon-button>
      </core-toolbar>
    </div>
  </template>

  <script>

    Polymer({
       /**
       * Fired when a response is received.
       *
       *    Usage:
       *
       *    search = document.querySelector('sc-search');
       * 
       *    search.addEventListener('sc-response', 
       *        function(e){ 
       *            console.log(e.detail.response['SCOPE'])
       *         })
       *
       *    Where SCOPE can to be any scope that grouping by returned objects as 
       *    messages, files, people, issues. 
       *
       * @event sc-response
       */      
      /**
       * The `author` attribute sets an initial author
       *
       * @attribute author
       * @type string
       * @default 'Horacio Ibrahim'
       */
      author: 'Horacio Ibrahim', 
      publish: {
          displaySearch: {value: false, reflect: true},        
      },
      /* the best place to the constructor for array or object */
      created: function() {
        // initialize but it not is turned public to use by users of the element
        // to turn public to use attributes or publish.
      },
      setIn: function() {
        var header = document.querySelector('sc-header');
        if (header) {
          if (header.style.display) {
            this.$.search.value = 'in: ';  
          }
        }
      },
      unsetIn: function() {
        if (this.$.search.value == 'in: ') {
          this.$.search;
        }
      },      
      onDisplaySearch: function(e, detail, sender) {
        this.displaySearch = !this.displaySearch;
        this.unsetIn();
        e.stopPropagation();
      },
      displaySearchChanged: function(){ // suffix functionally
        //this.$.search.focus(); this line conflicts anothers inputs
      },
      responseChanged: function() {  
          this.fire('sc-response', {response: this.response});
      },
      ready: function() {
        // Ready is a lifecycle callback.
        // You can do setup work in here.
        // More info: http://www.polymer-project.org/docs/polymer/polymer.html#lifecyclemethods
        // simple test alert(this.issueInfo.register);
        // var scnavbar = document.querySelector('sc-navbar');
        var searchComponent = this;
        this.changeParamRegister(document, 'sc-select', searchComponent)        
      },
      /**
       * The `toogleMenu` toggle drawer
       *
       * @method toogleMenu
       */        
      toogleMenu: function() {
          var coreDrawer = document.querySelector('core-drawer-panel');
          coreDrawer.togglePanel();
      },      
      /**
       * The `getSearch` makes of the requests for target URL when the input#search
       * is changed.
       *
       * @method getSearch
       * @type Object
       */         
      getSearch: function(e) {
        var threshold = 3; // minimal qtd chars to make requests
        var ajax = this.$.coreAjax;
        var term = this.$.search.value;
        var params = JSON.parse(ajax.params);
        
        data = {};
        data['term'] = term;
        data['register'] = params.register;

        if (term.indexOf('in:') === 0) {
          threshold = threshold * 2;
        }

        ajax.body = JSON.stringify(data);
        ajax.go();

      },
      /**
       * The `changeParamRegister` change URL of the core-ajax
       *
       * 
       * @method changeParamRegister
       * @param source an instance that generated the event
       * @param eventName the name of the event generated by source 
       * @param callback a callback or this custom element
       */       
      changeParamRegister: function(source, eventName, callback) {
        source.addEventListener(eventName, function(e){
              register = e.detail.issue;
              register = register.replace('/', '');
              var ajax = callback.$.coreAjax;
              var params = JSON.parse(ajax.params);
              params.register = register;
              ajax.params = JSON.stringify(params);
        });
      },
      showNotifications: function() {
        location.href = '/notifications';
      },
      showHashtags: function() {
        location.href = '/hashtags';
      }      
    });

  </script>

</polymer-element>
